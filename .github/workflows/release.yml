name: Release Datapack

on:
  push:
    branches:
      - main
    paths:
      - 'new_versions/**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get Latest Version
        id: version
        run: |
          latest_version=$(find new_versions -maxdepth 1 -mindepth 1 -type d -printf '%f\n' 2>/dev/null | sort -V | tail -n 1)

          if [ -z "$latest_version" ]; then
            echo "No version folders found"
            exit 1
          fi

          echo "Found Minecraft version: $latest_version"
          echo "mc_version=$latest_version" >> $GITHUB_OUTPUT
          echo "tag_name=$latest_version" >> $GITHUB_OUTPUT

      - name: Validate Datapack
        run: |
          datapack_path="new_versions/${{ steps.version.outputs.mc_version }}/datapack"

          if [ ! -d "$datapack_path" ]; then
            echo "Datapack folder missing"
            exit 1
          fi

          if [ ! -f "$datapack_path/pack.mcmeta" ]; then
            echo "pack.mcmeta missing"
            exit 1
          fi

          if [ ! -d "$datapack_path/data" ]; then
            echo "data folder missing"
            exit 1
          fi

          echo "Datapack structure validated"

      - name: Package Datapack
        run: |
          version="${{ steps.version.outputs.mc_version }}"
          datapack_path="new_versions/$version/datapack"
          zip_name="mc-server-toolkit-$version.zip"

          cd "$datapack_path"
          zip -r "$GITHUB_WORKSPACE/$zip_name" . -x "*.git*" -x ".DS_Store"

          echo "Created ZIP package:"
          ls -lh "$GITHUB_WORKSPACE/$zip_name"

      - name: Verify ZIP
        run: |
          version="${{ steps.version.outputs.mc_version }}"
          zip_name="mc-server-toolkit-$version.zip"

          if [ ! -f "$zip_name" ]; then
            echo "ZIP not found"
            exit 1
          fi

          unzip -t "$zip_name" > /dev/null
          echo "ZIP validated successfully"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag_name }}
          name: MC Server Toolkit ${{ steps.version.outputs.mc_version }}
          body: Release for Minecraft ${{ steps.version.outputs.mc_version }}
          files: mc-server-toolkit-${{ steps.version.outputs.mc_version }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
