name: Release Datapack

on:
  push:
    branches:
      - main
    paths:
      - 'new_versions/**/datapack/**'
  workflow_dispatch:

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Find latest version
        id: version
        run: |
          # En son minecraft versiyonunu bul
          latest=$(find new_versions -maxdepth 1 -mindepth 1 -type d | sed 's|new_versions/||' | sort -V | tail -n 1)
          
          if [ -z "$latest" ]; then
            echo "::error::No version folders found in new_versions/"
            exit 1
          fi
          
          echo "mc_version=$latest" >> $GITHUB_OUTPUT
          echo "tag_name=v$latest" >> $GITHUB_OUTPUT
          
          # Pack format oku
          mcmeta="new_versions/$latest/datapack/pack.mcmeta"
          if [ -f "$mcmeta" ]; then
            pack_format=$(jq -r '.pack.pack_format' "$mcmeta" 2>/dev/null || echo "1")
          else
            pack_format="1"
          fi
          
          echo "pack_format=$pack_format" >> $GITHUB_OUTPUT
          echo "Found version: $latest (pack format: $pack_format)"
      
      - name: Validate datapack structure
        run: |
          DATAPACK_DIR="new_versions/${{ steps.version.outputs.mc_version }}/datapack"
          
          # Dizin kontrolÃ¼
          if [ ! -d "$DATAPACK_DIR" ]; then
            echo "::error::Datapack folder not found: $DATAPACK_DIR"
            exit 1
          fi
          
          # pack.mcmeta kontrolÃ¼
          if [ ! -f "$DATAPACK_DIR/pack.mcmeta" ]; then
            echo "::error::pack.mcmeta not found"
            exit 1
          fi
          
          # data klasÃ¶rÃ¼ kontrolÃ¼
          if [ ! -d "$DATAPACK_DIR/data" ]; then
            echo "::error::data folder not found"
            exit 1
          fi
          
          echo "âœ“ Datapack structure is valid"
          tree "$DATAPACK_DIR" || ls -R "$DATAPACK_DIR"
      
      - name: Create ZIP package
        run: |
          DATAPACK_DIR="new_versions/${{ steps.version.outputs.mc_version }}/datapack"
          ZIP_NAME="mc-server-toolkit-${{ steps.version.outputs.mc_version }}.zip"
          
          cd "$DATAPACK_DIR"
          zip -r "$GITHUB_WORKSPACE/$ZIP_NAME" . -x "*.git*" -x "*__pycache__*" -x "*.DS_Store"
          
          cd "$GITHUB_WORKSPACE"
          ls -lh "$ZIP_NAME"
          unzip -l "$ZIP_NAME" | head -n 20
      
      - name: Generate changelog
        id: changelog
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -z "$PREV_TAG" ]; then
            CHANGES="Initial release for Minecraft ${{ steps.version.outputs.mc_version }}"
          else
            CHANGES=$(git log ${PREV_TAG}..HEAD --oneline --no-merges -- "new_versions/${{ steps.version.outputs.mc_version }}/datapack/**" | sed 's/^/- /' || echo "- No specific changes recorded")
          fi
          
          {
            echo "changelog<<CHANGELOG_EOF"
            echo "$CHANGES"
            echo "CHANGELOG_EOF"
          } >> $GITHUB_OUTPUT
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag_name }}
          name: "MC Server Toolkit v${{ steps.version.outputs.mc_version }}"
          body: |
            ## ðŸ“¦ Minecraft Server Toolkit Datapack
            
            **Minecraft Version:** `${{ steps.version.outputs.mc_version }}`  
            **Pack Format:** `${{ steps.version.outputs.pack_format }}`  
            **Build:** `${{ github.sha }}`
            
            ### ðŸ“ Changelog
            ${{ steps.changelog.outputs.changelog }}
            
            ### ðŸš€ Installation
            1. Download the ZIP file below
            2. Place it in your world's `datapacks` folder
            3. Run `/reload` in-game
            4. Verify with `/datapack list`
            
            ### â„¹ï¸ Requirements
            - Minecraft Java Edition ${{ steps.version.outputs.mc_version }}+
            - Server or singleplayer world with datapacks enabled
            
            ---
            
            **Having issues?** [Report a bug](https://github.com/${{ github.repository }}/issues)
          files: mc-server-toolkit-${{ steps.version.outputs.mc_version }}.zip
          draft: false
          prerelease: false
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Job Summary
        if: success()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## âœ… Release Published Successfully
          
          **Version:** ${{ steps.version.outputs.mc_version }}  
          **Tag:** ${{ steps.version.outputs.tag_name }}  
          **Pack Format:** ${{ steps.version.outputs.pack_format }}
          
          ðŸ”— [View Release](https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag_name }})
          EOF
```

**Bu versiyonda dÃ¼zelttiÄŸim kritik noktalar:**

1. âœ… `jq` ile JSON parse (daha gÃ¼venilir)
2. âœ… TÃ¼m path'ler tÄ±rnak iÃ§inde
3. âœ… Daha iyi hata mesajlarÄ±
4. âœ… Tree/ls ile yapÄ± gÃ¶rÃ¼nÃ¼mÃ¼
5. âœ… Changelog heredoc syntax dÃ¼zeltildi
6. âœ… Gereksiz parametreler kaldÄ±rÄ±ldÄ±

**Dizin yapÄ±nÄ±z ÅŸÃ¶yle olmalÄ±:**
```
new_versions/
â””â”€â”€ 1.21/
    â””â”€â”€ datapack/
        â”œâ”€â”€ pack.mcmeta
        â””â”€â”€ data/
            â””â”€â”€ ...
