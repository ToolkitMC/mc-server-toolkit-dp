name: Clean Dangerous Files

on:
  push:
    paths:
      - new_versions/**
  pull_request:
    paths:
      - new_versions/**
  workflow_dispatch:

jobs:
  clean-files:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Scan datapacks
        id: scan
        shell: bash
        run: |
          set -e

          DANGEROUS_EXTENSIONS="sh js exe bat cmd ps1 py rb pl jar dll so dylib vbs com msi app deb rpm"
          DELETED=0

          for ext in $DANGEROUS_EXTENSIONS; do
            while IFS= read -r file; do
              echo "Found dangerous file: $file"

              if [ "$GITHUB_EVENT_NAME" = "pull_request" ]; then
                echo "::error file=$file::.$ext files are not allowed in datapacks"
                DELETED=1
              else
                rm -f "$file"
                DELETED=1
              fi
            done < <(find new_versions -type f -name "*.$ext" -path "*datapack*" 2>/dev/null)
          done

          echo "file_found=$DELETED" >> "$GITHUB_OUTPUT"

          if [ "$GITHUB_EVENT_NAME" = "pull_request" ] && [ "$DELETED" -eq 1 ]; then
            exit 1
          fi

      - name: Commit changes
        if: github.event_name != 'pull_request' && steps.scan.outputs.file_found == '1'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "Security: remove dangerous files from datapacks"
          git push
