name: Clean Dangerous Files

on:
  push:
    paths:
      - 'new_versions/**'
  workflow_dispatch:
  pull_request:
    paths:
      - 'new_versions/**'

jobs:
  clean-files:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Scan and delete dangerous files
        id: scan
        run: |
          set -euo pipefail

          echo "üîç Scanning for dangerous files in new_versions/*datapack*"

          DANGEROUS_EXTENSIONS=("sh" "js" "exe" "bat" "cmd" "ps1" "py" "rb" "pl" "jar" "dll" "so" "dylib" "vbs" "com" "msi" "app" "deb" "rpm")

          DELETED_FILES=()

          FIND_PATTERN=""
          for ext in "${DANGEROUS_EXTENSIONS[@]}"; do
            if [ -z "$FIND_PATTERN" ]; then
              FIND_PATTERN="-name *.$ext"
            else
              FIND_PATTERN="$FIND_PATTERN -o -name *.$ext"
            fi
          done

          while IFS= read -r -d '' file; do
            echo "‚ö†Ô∏è  Found dangerous file: $file"

            if [ "${{ github.event_name }}" == "pull_request" ]; then
              ext="${file##*.}"
              echo "::error file=$file,title=Security: Dangerous file detected::.$ext files are not allowed in Minecraft datapacks."
              DELETED_FILES+=("$file")
            else
              rm -f "$file"
              DELETED_FILES+=("$file")
              echo "üóëÔ∏è  Deleted: $file"
            fi
          done < <(find new_versions -type f \( $FIND_PATTERN \) -path "*datapack*" -print0 2>/dev/null | sort -z -u)

          FILE_COUNT=${#DELETED_FILES[@]}

          if [ $FILE_COUNT -eq 0 ]; then
            echo "‚úÖ No dangerous files found."
            echo "file_count=0" >> $GITHUB_OUTPUT
          else
            echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
            printf '%s\n' "${DELETED_FILES[@]}" | sort -u > deleted_files.log

            if [ "${{ github.event_name }}" == "pull_request" ]; then
              echo "::error::PR contains dangerous files."
              exit 1
            fi
          fi

      - name: Commit changes if files were deleted
        if: github.event_name != 'pull_request' && steps.scan.outputs.file_count != '0'
        run: |
          set -euo pipefail

          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          if [ -n "$(git status --porcelain)" ]; then
            FILE_COUNT=$(wc -l < deleted_files.log)

            git add -A
            git commit -m "üõ°Ô∏è Security: Auto-removed $FILE_COUNT dangerous file(s)"
            git push
          fi

      - name: Upload deletion log
        if: always() && steps.scan.outputs.file_count != '0'
        uses: actions/upload-artifact@v4
        with:
          name: deletion-log-${{ github.run_number }}-${{ github.run_attempt }}
          path: deleted_files.log
          retention-days: 90

      - name: Generate summary
        if: always()
        run: |
          echo "## üõ°Ô∏è Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow:** \`${{ github.workflow }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Run:** #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
